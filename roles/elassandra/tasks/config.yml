---
- name: Setting facts for RPM Elassanda install
  set_fact:
    elassandra_home: "/usr/share/cassandra"
    elassandra_conf: "/etc/cassandra"
    elassandra_bin: "/usr/bin"
    elassandra_plugins: "/usr/share/cassandra/plugins"
    elassandra_logs: "/var/log/cassandra"
    elassandra_data: "/var/lib/cassandra"

#- name: "Add elassandra to /etc/hosts"
#  lineinfile:
#    dest: /etc/hosts
#    regexp: '.*elassandra$'
#    line: "{{ elassandra_broadcast_rpc_address }} elassandra"
#    state: present

- name: Build configuration files locally
  template: src={{ item }} dest={{ elassandra_conf }}/{{ item }} owner={{ elassandra_user }} group={{ elassandra_group }} mode=0644
  become: true
  with_items:
   - elasticsearch.yml
   - cassandra.yaml
   - cassandra-env.sh
   - cassandra-rackdc.properties
   - cassandra-topology.properties
   #- influxdb-reporting.yaml
   - logback.xml
   - cassandra-rackdc.properties
   - jvm.options
   #- license.json

- name: Copy /usr/java/jdk1.8/jre/lib/management/jmxremote.access
  copy: src=jmxremote.access dest={{ java_home }}/jre/lib/management/jmxremote.access owner=root group=root mode=0644
  become: true

- name: Copy /etc/cassandra/jmxremote.password
  template: src=jmxremote.password dest=/etc/cassandra/jmxremote.password owner={{ elassandra_user }} group={{ elassandra_group }} mode=0400
  become: true

- name: Grant read access to /etc/cassandra/jmxremote.password
  acl:
    path: /etc/cassandra/jmxremote.password
    entity: "{{ item }}"
    etype: user
    permissions: r
    state: present
  become: true
  with_items:
    - "{{ remote_user }}"
    - root

#- name: Copy aliases.sh to /etc/profile.d/cassandra.sh
#  become: true
#  copy: src=/usr/share/cassandra/aliases.sh dest=/etc/profile.d/cassandra.sh

#- name: Update owner of /etc/profile.d/cassandra.sh
#  become: true
#  file: owner={{ elassandra_user }} group={{ elassandra_group }} mode=0664

- name: Ensure firewalld is started
  become: true
  systemd:
    name: firewalld
    enabled: yes
    state: started
    masked: no

- name: Build start configuration in /etc/sysconfig/cassandra
  template: src=sysconfig-cassandra.j2 dest=/etc/sysconfig/cassandra owner=root group=root mode=0664
  become: true

# TODO: separate rules for interconnect et rpc networks.
- name: Open firewalld incomming ports on interconnect (7000+7001+7199 + 9300-9400) + rpc networks (9042+9142+9160 + 9200-9300)
  become: true
  firewalld:
    port: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
  with_items:
    - 7000/tcp
    - 7001/tcp
    - 7199/tcp
    - 9042/tcp
    - 9142/tcp
    - 9160/tcp
    - 9200-9400/tcp
    - 7500/tcp

- name: Set permission on /var/log/cassandra and /var/lib/cassandra
  become: true
  file:
    path: "{{ item }}"
    state: directory
    owner: cassandra
    group: cassandra
    mode: 0755
  with_items:
    - /var/log/cassandra
    - /var/lib/cassandra

- name: Ensure cassandra data directories exists
  become: true
  file:
    path: "{{ item }}"
    state: directory
    owner: cassandra
    group: cassandra
    mode: 0755
  with_items: elassandra_data_file_directories
  when: elassandra_data_file_directories is defined

- name: Ensure elassandra_metadata_directory exists
  become: true
  file:
    path:  /mnt/cass_data_disks/data1/metadata
    state: directory
    owner: cassandra
    group: cassandra
    mode: 0755
  when: elassandra_metadata_directory is defined

- name: Ensure elassandra_hints_directory exists
  become: true
  file:
    path:  /mnt/cass_data_disks/data1/hints
    state: directory
    owner: cassandra
    group: cassandra
    mode: 0755
  when: elassandra_hints_directory is defined

- name: Ensure elassandra_commitlog_directory exists
  become: true
  file:
    path:  /mnt/cass_data_disks/data1/commitlog
    state: directory
    owner: cassandra
    group: cassandra
    mode: 0755
  when: elassandra_commitlog_directory is defined

- name: Ensure elassandra_cdc_raw_directory exists
  become: true
  file:
    path:  /mnt/cass_data_disks/data1/cdc_raw
    state: directory
    owner: cassandra
    group: cassandra
    mode: 0755
  when: elassandra_cdc_raw_directory is defined

- name: Ensure elassandra_saved_caches_directory exists
  become: true
  file:
    path:  /mnt/cass_data_disks/data1/saved_caches
    state: directory
    owner: cassandra
    group: cassandra
    mode: 0755
  when: elassandra_saved_caches_directory is defined

- name: Ensure .cassandra directory exists
  become: true
  file:
    path: "{{ item.home }}/.cassandra"
    state: directory
    owner: "{{ item.user }}"
    group: "{{ item.group }}"
    mode: 0700
  with_items:
    - { home: "/home/{{ remote_user }}", user: "{{ remote_user }}", group: "{{ remote_user }}" }
    - { home: /root, user: root, group: root }

- name: "Deploy cqlshrc for root and {{ remote_user }}"
  become: true
  template:
    src: cqlshrc
    dest: "{{ item.home }}/.cassandra/cqlshrc"
    owner: "{{ item.user }}"
    group: "{{ item.group }}"
    mode: 0400
  with_items:
    - { home: "/home/{{ remote_user }}", user: "{{ remote_user }}", group: "{{ remote_user }}" }
    - { home: /root, user: root, group: root }

- name: "Deploy nodetool-ssl.properties for root and {{ remote_user }}"
  become: true
  template:
    src: nodetool-ssl.properties
    dest: "{{ item.home }}/.cassandra/nodetool-ssl.properties"
    owner: "{{ item.user }}"
    group: "{{ item.group }}"
    mode: 0400
  with_items:
    - { home: "/home/{{ remote_user }}", user: "{{ remote_user }}", group: "{{ remote_user }}" }
    - { home: /root , user: root, group: root }

- name: "Deploy curlrc for root and {{ remote_user }}"
  become: true
  template:
    src: curlrc
    dest: "{{ item.home }}/.curlrc"
    owner: "{{ item.user }}"
    group: "{{ item.group }}"
    mode: 0400
  with_items:
    - { home: "/home/{{ remote_user }}", user: "{{ remote_user }}", group: "{{ remote_user }}" }
    - { home: /root, user: root, group: root }
